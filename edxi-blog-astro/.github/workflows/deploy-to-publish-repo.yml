name: Build and Deploy to publish repo

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Checkout legacy source repo for migration audit
        uses: actions/checkout@v4
        with:
          repository: edxi/edxi.github.io
          path: legacy-source

      - name: Audit migration parity
        env:
          LEGACY_BLOG_ROOT: legacy-source
        run: npm run audit:migration

      - name: Verify migration audit gate (negative fixture)
        env:
          LEGACY_BLOG_ROOT: legacy-source
        run: npm run audit:migration:verify-gate

      - name: Append migration parity summary
        if: always()
        run: |
          node <<'NODE'
          const fs = require('node:fs');
          const reportPath = 'docs/MIGRATION_AUDIT.json';
          const summaryPath = process.env.GITHUB_STEP_SUMMARY;

          function append(text) {
            if (!summaryPath) return;
            fs.appendFileSync(summaryPath, `${text}\n`, 'utf8');
          }

          if (!fs.existsSync(reportPath)) {
            console.warn(`Warning: ${reportPath} not found; skipping parity summary.`);
            append('## Migration parity');
            append('- WARNING: `docs/MIGRATION_AUDIT.json` not found; summary unavailable.');
            process.exit(0);
          }

          try {
            const raw = fs.readFileSync(reportPath, 'utf8');
            const r = JSON.parse(raw);
            append('## Migration parity');
            append(`- Generated: ${r.generatedAt ?? 'unknown'}`);
            append(`- Legacy posts: ${r.totalLegacyPosts ?? 'n/a'}`);
            append(`- Astro posts: ${r.totalAstroPosts ?? 'n/a'}`);
            append(`- Missing in Astro: ${Array.isArray(r.missingInAstro) ? r.missingInAstro.length : 'n/a'}`);
            append(`- Extra in Astro: ${Array.isArray(r.extraInAstro) ? r.extraInAstro.length : 'n/a'}`);
            append(`- Missing paths in Astro: ${Array.isArray(r.missingPathsInAstro) ? r.missingPathsInAstro.length : 'n/a'}`);
            append(`- Extra paths in Astro: ${Array.isArray(r.extraPathsInAstro) ? r.extraPathsInAstro.length : 'n/a'}`);
            const metadataFindings =
              r && typeof r === 'object' &&
              r.metadataFindings && typeof r.metadataFindings === 'object' &&
              typeof r.metadataFindings.hasFindings === 'boolean'
                ? (r.metadataFindings.hasFindings ? 'yes' : 'no')
                : 'n/a';
            append(`- Metadata findings: ${metadataFindings}`);
            append(`- Has diffs: ${r.hasDiffs === true ? 'yes' : 'no'}`);
          } catch (error) {
            const msg = error instanceof Error ? error.message : String(error);
            console.warn(`Warning: failed to read ${reportPath}: ${msg}`);
            append('## Migration parity');
            append(`- WARNING: Failed to parse \`docs/MIGRATION_AUDIT.json\`: ${msg}`);
            process.exit(0);
          }
          NODE

      - name: Build Astro
        run: npm run build

      - name: Upload migration audit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-audit-report
          path: |
            docs/MIGRATION_AUDIT.md
            docs/MIGRATION_AUDIT.json
          if-no-files-found: warn

      - name: Deploy dist to publish repository
        uses: peaceiris/actions-gh-pages@v4
        with:
          deploy_key: ${{ secrets.PUBLISH_REPO_DEPLOY_KEY }}
          external_repository: miniade/miniade.github.io
          publish_branch: master
          publish_dir: ./dist
          force_orphan: true
          user_name: github-actions[bot]
          user_email: 41898282+github-actions[bot]@users.noreply.github.com
